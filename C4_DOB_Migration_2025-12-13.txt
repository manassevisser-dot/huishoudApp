
W&I Wizard — C4 DOB Migration (Tailored) — 2025-12-13
=====================================================

This patch is tailored to your repo based on your audit output:
- `src/organisms/HouseholdMemberRepeater.tsx` contains `geboorteDatum` at lines ~112, 245, 250, 252, 341, 346, 348.
- It still renders two **Leeftijd** inputs (adult + child) with placeholders "18 of ouder" and "Jonger dan 18".
- `src/types/household.ts` still lists `geboorteDatum?: string;`.

What this patch does
--------------------
1) **Remove manual "Leeftijd" inputs** from C4 (both adult & child cards).
2) **Switch to canonical `dateOfBirth` (ISO)** everywhere in C4.
   - NL input (DD-MM-YYYY) → parse to ISO for storage (`dateOfBirth`).
   - Render back as NL (`formatDate(iso,'dd-mm-yyyy')`).
   - Recompute `leeftijd` automatically using `calculateAge(iso)`.
3) **Keyboard** for date input → `number-pad` (mobile friendly).
4) **Remove** `geboorteDatum` from `Member` type.
5) (Optional) **Migration effect** to convert any persisted `geboorteDatum` to `dateOfBirth` once.

How to apply safely
-------------------
1) Save this file as `W&I_Wizard_C4_DOB_Migration_Tailored_2025-12-13.txt` at repo root.
2) Dry-run:
   ```bash
   git apply --check W&I_Wizard_C4_DOB_Migration_Tailored_2025-12-13.txt
   ```
   If OK → apply:
   ```bash
   git apply W&I_Wizard_C4_DOB_Migration_Tailored_2025-12-13.txt
   ```
3) Restart the app and verify.

Unified diffs
-------------

*** 1) src/types/household.ts ***

--- a/src/types/household.ts
+++ b/src/types/household.ts
@@
 export type Member = {
   id: string;
   memberType: 'adult' | 'child';
   naam?: string;
   leeftijd?: number; // COMPUTED: Age calculated from dateOfBirth, kept for backward compatibility
   dateOfBirth?: string; // CANONICAL: ISO YYYY-MM-DD format (e.g., "1985-03-15")
   gender?: 'man' | 'vrouw' | 'anders' | 'n.v.t.';
-  geboorteDatum?: string; // DEPRECATED: Use dateOfBirth instead, kept temporarily for migration
 };

 export type BurgerlijkeStaat =
   | 'Gehuwd'
   | 'Fiscaal Partners'
   | 'Samenwonend'
   | 'Bevriend'
   | 'Anders'
   | 'Alleenstaand';

*** 2) src/organisms/HouseholdMemberRepeater.tsx ***

--- a/src/organisms/HouseholdMemberRepeater.tsx
+++ b/src/organisms/HouseholdMemberRepeater.tsx
@@
-            geboorteDatum: undefined,
+            dateOfBirth: undefined,
@@
-          <Text style={styles.label}>Geboortedatum</Text>
-          <TextInput
-            style={[styles.input, ageError && styles.inputError]}
-            value={m.geboorteDatum ? formatDate(m.geboorteDatum, 'dd-mm-yyyy') : ''}
-            onChangeText={(text) => {
-              const iso = parseDDMMYYYYtoISO(text);
-              if (iso) {
-                const age = calculateAge(iso);
-                updateMember(index, { geboorteDatum: iso, leeftijd: age ?? undefined });
-              } else {
-                updateMember(index, { geboorteDatum: undefined, leeftijd: undefined });
-              }
-            }}
-            placeholder="DD-MM-YYYY"
-            keyboardType="numbers-and-punctuation"
-            maxLength={10}
-            accessibilityLabel={`Geboortedatum voor ${title}`}
-          />
+          <Text style={styles.label}>Geboortedatum</Text>
+          <TextInput
+            style={[styles.input, ageError && styles.inputError]}
+            value={m.dateOfBirth ? formatDate(m.dateOfBirth, 'dd-mm-yyyy') : ''}
+            onChangeText={(text) => {
+              const iso = parseDDMMYYYYtoISO(text);
+              if (iso) {
+                const age = calculateAge(iso);
+                updateMember(index, { dateOfBirth: iso, leeftijd: age ?? undefined });
+              } else {
+                updateMember(index, { dateOfBirth: undefined, leeftijd: undefined });
+              }
+            }}
+            placeholder="DD-MM-YYYY"
+            keyboardType="number-pad"
+            maxLength={10}
+            accessibilityLabel={`Geboortedatum voor ${title}`}
+          />
@@
-        <View style={styles.fieldContainer}>
-          <Text style={styles.label}>Leeftijd</Text>
-          <TextInput
-            style={
-              ageError
-                ? [styles.numericInput, styles.inputError]
-                : styles.numericInput
-            }
-            value={
-              m.leeftijd !== undefined && m.leeftijd !== null
-                ? String(m.leeftijd)
-                : ''
-            }
-            keyboardType="number-pad"
-            maxLength={2}
-            onChangeText={(text) => {
-              const clean = onlyDigits(text).slice(0, 2);
-              const n = clean.length ? Number(clean) : undefined;
-              updateMember(index, { leeftijd: n });
-            }}
-            placeholder="18 of ouder"
-            accessibilityLabel={`Leeftijd voor ${title}`}
-          />
-          {ageError && <Text style={styles.errorTextStyle}>{ageError}</Text>}
-        </View>
+        {ageError && <Text style={styles.errorTextStyle}>{ageError}</Text>}
@@
-          <Text style={styles.label}>Geboortedatum</Text>
-          <TextInput
-            style={[styles.input, ageError && styles.inputError]}
-            value={m.geboorteDatum ? formatDate(m.geboorteDatum, 'dd-mm-yyyy') : ''}
-            onChangeText={(text) => {
-              const iso = parseDDMMYYYYtoISO(text);
-              if (iso) {
-                const age = calculateAge(iso);
-                updateMember(index, { geboorteDatum: iso, leeftijd: age ?? undefined });
-              } else {
-                updateMember(index, { geboorteDatum: undefined, leeftijd: undefined });
-              }
-            }}
-            placeholder="DD-MM-YYYY"
-            keyboardType="numbers-and-punctuation"
-            maxLength={10}
-            accessibilityLabel={`Geboortedatum voor ${title}`}
-          />
+          <Text style={styles.label}>Geboortedatum</Text>
+          <TextInput
+            style={[styles.input, ageError && styles.inputError]}
+            value={m.dateOfBirth ? formatDate(m.dateOfBirth, 'dd-mm-yyyy') : ''}
+            onChangeText={(text) => {
+              const iso = parseDDMMYYYYtoISO(text);
+              if (iso) {
+                const age = calculateAge(iso);
+                updateMember(index, { dateOfBirth: iso, leeftijd: age ?? undefined });
+              } else {
+                updateMember(index, { dateOfBirth: undefined, leeftijd: undefined });
+              }
+            }}
+            placeholder="DD-MM-YYYY"
+            keyboardType="number-pad"
+            maxLength={10}
+            accessibilityLabel={`Geboortedatum voor ${title}`}
+          />
@@
-        <View style={styles.fieldContainer}>
-          <Text style={styles.label}>Leeftijd</Text>
-          <TextInput
-            style={
-              ageError
-                ? [styles.numericInput, styles.inputError]
-                : styles.numericInput
-            }
-            value={
-              m.leeftijd !== undefined && m.leeftijd !== null
-                ? String(m.leeftijd)
-                : ''
-            }
-            keyboardType="number-pad"
-            maxLength={2}
-            onChangeText={(text) => {
-              const clean = onlyDigits(text).slice(0, 2);
-              const n = clean.length ? Number(clean) : undefined;
-              updateMember(index, { leeftijd: n });
-            }}
-            placeholder="Jonger dan 18"
-            accessibilityLabel={`Leeftijd voor ${title}`}
-          />
-          {ageError && <Text style={styles.errorTextStyle}>{ageError}</Text>}
-        </View>
+        {ageError && <Text style={styles.errorTextStyle}>{ageError}</Text>}


*** 3) (Optional) One-time migration in HouseholdMemberRepeater.tsx ***
# Uncomment to enable (remove leading "# ")
@@
# React.useEffect(() => {
#   const raw = Array.isArray(state.C4?.leden) ? (state.C4!.leden as any[]) : [];
#   const migrated = raw.map((m) => {
#     const legacy = m?.geboorteDatum as string | undefined;
#     if (legacy && !m?.dateOfBirth) {
#       const iso = legacy;
#       const age = iso ? calculateAge(iso) ?? undefined : undefined;
#       const { geboorteDatum, ...rest } = m;
#       return { ...rest, dateOfBirth: iso, leeftijd: age };
#     }
#     return m;
#   });
#   const changed = migrated.length === raw.length && migrated.some((m, i) => m !== raw[i]);
#   if (changed) {
#     dispatch({ type: 'SET_PAGE_DATA', pageId: 'C4', data: { leden: migrated } });
#   }
#   // eslint-disable-next-line react-hooks/exhaustive-deps
# }, []);

Post-apply verification
-----------------------
1) No occurrences of `geboorteDatum` remain:
   ```bash
   grep -RIn --include="*.ts*" "geboorteDatum" src || echo "OK: none"
   ```
2) No **Leeftijd** input blocks remain (labels/placeholders). Error texts may still mention "Leeftijd" which is fine:
   ```bash
   grep -RIn --include="*.ts*" -e "<Text style={styles.label}>Leeftijd" -e "placeholder=\"18 of ouder\"" -e "placeholder=\"Jonger dan 18\"" src || echo "OK: input removed"
   ```
3) Date inputs use **number-pad**:
   ```bash
   grep -RIn --include="*.ts*" "keyboardType=\"number-pad\"" src | wc -l
   ```
4) C4: typing `12-03-2010` stores `2010-03-12` in `dateOfBirth` and recomputes `leeftijd` automatically.

Rollback
--------
If anything looks off:
```bash
git apply -R W&I_Wizard_C4_DOB_Migration_Tailored_2025-12-13.txt
```

