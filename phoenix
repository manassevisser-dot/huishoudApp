#!/usr/bin/env bash
# Phoenix Commander v3.3 â€” "Research Edition"
# ... (bestaande exports en log_node functies blijven gelijk)

# ============ Research & Harvest Sectie ============

cmd_harvest() {
    log_info "ğŸŒ¾ De oogst begint: Validatie van Onderzoeks-integriteit..."
    
    # 1. TypeScript Check (zonder output te vervuilen)
    log_info "ğŸ” Controleren op Type-mismatches..."
    if ! npx tsc --noEmit; then
        log_err "TypeScript errors gevonden! De oogst is mogelijk vervuild."
        exit 1
    fi

    # 2. Draai de specifieke onderzoeks-tests
    log_info "ğŸ§ª Draaien van integriteitstests..."
    npm test -- --coverage --threshold=80 --testNamePattern='Onderzoeks-integriteit'
    
    log_ok "âœ… Oogst voltooid: Data is consistent en geanonimiseerd."
}

cmd_debug_research() {
    log_warn "ğŸ›  Debug modus: Focus op Onderzoeks-integriteit..."
    npx jest --watchAll -t 'Onderzoeks-integriteit'
}

# ============ De Verrassing: PII Scanner ============
# Een snelle bash-check om te zien of er per ongeluk 'firstName' in onderzoekscodes lekt
cmd_pii_scan() {
    log_warn "ğŸ•µï¸  Scannen op PII-lekken in onderzoekspaden..."
    # Zoekt naar patronen waarbij namen direct in researchPayloads worden gepusht
    if grep -r "researchPayload.*firstName" src/services; then
        log_err "PII LEK GEVONDEN! firstName gedetecteerd in researchPayload."
    else
        log_ok "Geen duidelijke PII-lekken gevonden in de services."
    fi
}

# ============ Dispatcher (GeÃ¼pdatet) ============
case "${1:-}" in
  full)         shift; cmd_full "$@" ;;
  harvest)      cmd_harvest ;;         # Nieuw!
  harvest-debug) cmd_debug_research ;; # Nieuw!
  scan)         cmd_pii_scan ;;        # De verrassing!
  all)          shift; cmd_all "$@" ;;
  audit)        _cmd_audit ;;
  dedup)        _cmd_dedup ;;
  fix|sanity)   shift; _cmd_sanity "$@" ;; 
  migrate)      shift; _cmd_migrate "$@" ;;
  clean)        cmd_clean ;;
  ""|help|-h|--help) cmd_help; exit 0 ;;
  *) 
    echo -e "${RED}${ICON_FAIL} Onbekend commando: ${1}${NC}"
    cmd_help; exit 1 ;;
esac