#!/usr/bin/env bash
# Phoenix Commander v3.1 ‚Äî 2025-12-27
set -euo pipefail
PROJECT_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
export PROJECT_ROOT
# ... (Je Bridge functies) ...
# Terminal Colors & Icons
RED='\033[0;31m'
NC='\033[0m'
ICON_FAIL='‚ùå'

log_node() {
    node -e "const l=require('${PROJECT_ROOT}/scripts/utils/logger'); $1"
}

log_info() { log_node "l.info('$1')"; }
log_ok()   { log_node "l.ok('$1')"; }
log_warn() { log_node "l.warn('$1')"; }
log_err()  { log_node "l.error('$1')"; }
log_val()  { log_node "l.$1(l.TEXT['$2']('$3'))"; }

# DIT IS HET CRUCIALE DEEL: Exporteer de functies naar sub-processen
export -f log_node
export -f log_info
export -f log_ok
export -f log_warn
export -f log_err
export -f log_val

# ============ Orchestrator Dispatcher ============

cmd_full() {

    # 1. Draai de statische audit (wat je nu ziet)

    node scripts/maintenance/audit-orchestrator.js "$@"

    

    # 2. Draai de daadwerkelijke tests voor de coverage

    log_info "üß™ Starten van de Phoenix Test Suite (Jest)..."

    npm test -- --coverage --watchAll=false

}

cmd_all() {
    node scripts/maintenance/audit-orchestrator.js "$@"
}

_cmd_sanity() {
    node scripts/sync-aliases/index.js "$@"
}

_cmd_dedup() {
    bash scripts/maintenance/phoenix_dedup.sh src
}

_cmd_audit() {
    # Hiermee vertellen we phoenix-check: "Ik ben de baas, jij hoeft niet te loggen"
    export PHOENIX_INTERNAL=true
    bash scripts/maintenance/phoenix-check.sh
}

# ============ Dispatcher ============
case "${1:-}" in
  full)        cmd_full "$@" ;;
  all)         cmd_all "$@" ;; # Nu luistert hij ook naar 'full'
  audit)      _cmd_audit ;;
  dedup)      _cmd_dedup ;;
  fix|sanity) _cmd_sanity "$@" ;; 
  clean)       cmd_clean ;;
  ""|help|-h|--help) cmd_help; exit 0 ;;
  *) 
    echo -e "${RED}${ICON_FAIL} Onbekend commando: ${1}${NC}"
    cmd_help
    exit 1 
    ;;
esac