#!/usr/bin/env bash
# Phoenix Commander v3.3 â€“ dispatcher
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export PROJECT_ROOT
source "$PROJECT_ROOT/scripts/utils/log_bridge.sh"

check_dependencies() {
  local deps=(node npm bash grep awk sed)
  for cmd in "${deps[@]}"; do
    command -v "$cmd" >/dev/null || { log_err "Missing dependency: $cmd"; exit 40; }
  done
}

cmd_full() {
  node scripts/maintenance/audit-orchestrator.js "$@" 2>/dev/null || true
  log_info "ðŸ§ª Starten van de Phoenix Test Suite (Jest)â€¦"
  npm test -- --coverage --watchAll=false || true
}
cmd_all()      { node scripts/maintenance/audit-orchestrator.js "$@" || true; }
_cmd_sanity()  { node scripts/sync-aliases/index.js "$@" || true; }
_cmd_dedup()   { bash scripts/maintenance/phoenix_dedup.sh src || true; }
_cmd_audit()   { PHOENIX_INTERNAL=true bash scripts/maintenance/phoenix-check.sh; }
cmd_health()   { echo "ðŸ¥ Phoenix Health Check"; check_dependencies; echo "âœ… All systems operational"; }
cmd_watch()    { while true; do clear; _cmd_audit; sleep 5; done; }
cmd_rollback() {
  local latest
  latest=$(ls -t backups/phoenix-* 2>/dev/null | head -1 || true)
  [[ -z "$latest" ]] && { echo "No backups found."; return 0; }
  read -p "Restore from $latest ? (y/N) " -n 1 -r; echo
  [[ $REPLY =~ ^[Yy]$ ]] || return 0
  cp -r "$latest/"* ./
  echo "âœ… Restored from $latest"
}
cmd_help() {
  cat <<HLP
Phoenix Commander v3.3
Usage:
  ./phoenix full|all|audit|dedup|health|watch|rollback|help
HLP
}

case "${1:-}" in
  full) cmd_full   "$@" ;;
  all)  cmd_all    "$@" ;;
  audit) _cmd_audit ;;
  dedup) _cmd_dedup ;;
  health) cmd_health ;;
  watch) cmd_watch ;;
  rollback) cmd_rollback ;;
  ""|help|-h|--help) cmd_help; exit 0 ;;
  *) echo -e "âŒ Onbekend commando: ${1}"; cmd_help; exit 1;;
esac
